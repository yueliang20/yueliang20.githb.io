<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­çº§æˆç»©è¿›é˜¶åˆ†æç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --white: #ffffff;
            --text: #334155;
            --border: #e2e8f0;
            --green: #16a34a;
            --red: #dc2626;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* é¡¶éƒ¨å¡ç‰‡ */
        .control-panel {
            background: var(--white);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }

        h1 { margin: 0; font-size: 1.5rem; color: #1e293b; }
        
        .upload-btn {
            background-color: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        .upload-btn:hover { background-color: #1d4ed8; }
        input[type="file"] { display: none; }

        /* é€‰æ‹©å™¨åŒºåŸŸ */
        .selectors {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .select-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .select-group label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 600;
        }

        select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            min-width: 200px;
            background-color: #fff;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--white);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            text-align: center;
        }
        .stat-num { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        .stat-desc { font-size: 0.85rem; color: #64748b; }

        /* è¡¨æ ¼æ ·å¼ */
        .table-responsive {
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        thead { background-color: #f1f5f9; }
        
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th { font-weight: 600; color: #475569; white-space: nowrap; }

        /* æˆç»©å˜åŒ–æ ·å¼ */
        .diff-pos { color: var(--green); font-weight: bold; }
        .diff-neg { color: var(--red); font-weight: bold; }
        .diff-neutral { color: #94a3b8; }

        /* å¹³å‡åˆ†å·®è·æ ‡ç­¾ */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .bg-green { background-color: #dcfce7; color: #166534; }
        .bg-red { background-color: #fee2e2; color: #991b1b; }

        /* ç§‘ç›®å°åˆ†æ ·å¼ */
        .sub-score {
            font-size: 0.85rem;
            color: #64748b;
            margin-right: 8px;
        }
        .sub-score span { color: #334155; font-weight: 500; }

        .loading { text-align: center; padding: 40px; color: #64748b; display: none; }
        .empty-tip { text-align: center; padding: 50px; color: #94a3b8; }
    </style>
</head>
<body>

<div class="container">
    <div class="control-panel">
        <div class="header-row">
            <div>
                <h1>ğŸ“ˆ ç­çº§æˆç»©åˆ†æ Pro</h1>
                <p style="margin:5px 0 0; font-size:0.9rem; color:#64748b">æ”¯æŒå¤šåœºè€ƒè¯•æ¨ªå‘å¯¹æ¯”ï¼ˆè§£ææ ¼å¼ï¼šè¡Œ1=è€ƒè¯•åï¼Œè¡Œ4=è¡¨å¤´ï¼‰</p>
            </div>
            <label class="upload-btn">
                ğŸ“‚ å¯¼å…¥ Excel
                <input type="file" id="fileInput" accept=".xlsx, .xls" onchange="handleFile(this)">
            </label>
        </div>

        <div class="selectors">
            <div class="select-group">
                <label>é€‰æ‹©ã€æœ¬æ¬¡è€ƒè¯•ã€‘</label>
                <select id="currentExamSelect" onchange="updateAnalysis()"></select>
            </div>
            <div class="select-group">
                <label>é€‰æ‹©ã€å¯¹æ¯”å‚è€ƒã€‘</label>
                <select id="prevExamSelect" onchange="updateAnalysis()"></select>
            </div>
            <div style="margin-left:auto; font-size:0.9rem; color:#64748b" id="examInfo"></div>
        </div>
    </div>

    <div class="stats-bar" id="statsBar" style="display:none;">
        <div class="stat-card">
            <div class="stat-num" id="statAvg">0</div>
            <div class="stat-desc">æœ¬æ¬¡å¹³å‡åˆ†</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" id="statMax">0</div>
            <div class="stat-desc">æœ¬æ¬¡æœ€é«˜åˆ†</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" id="statProgress">0</div>
            <div class="stat-desc">è¿›æ­¥äººæ•°</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" id="statRegress">0</div>
            <div class="stat-desc">é€€æ­¥äººæ•°</div>
        </div>
    </div>

    <div class="table-responsive">
        <table id="scoreTable">
            <thead>
                <tr>
                    <th>å§“å</th>
                    <th>å¯¹æ¯”è€ƒè¯•æ€»åˆ†</th>
                    <th>æœ¬æ¬¡æ€»åˆ†</th>
                    <th>è¾ƒå‚è€ƒå˜åŒ–</th>
                    <th>ä¸å‡åˆ†å·®è·</th>
                    <th>å•ç§‘è¯¦æƒ… (è‹±/è®¡/æ•°)</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="6" class="empty-tip">è¯·å…ˆå¯¼å…¥è¡¨æ ¼æ•°æ®...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // å…¨å±€æ•°æ®å­˜å‚¨ï¼šç»“æ„ä¸º { "ç¬¬ä¸€æ¬¡æœˆè€ƒ": [å­¦ç”Ÿå¯¹è±¡], "å‘¨æµ‹1": [å­¦ç”Ÿå¯¹è±¡] }
    let globalExamData = {};
    let examNamesList = [];

    function handleFile(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            
            // é»˜è®¤è¯»å–ç¬¬ä¸€ä¸ª Sheet
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            
            // è½¬æ¢ä¸º JSON (æ•°ç»„çš„æ•°ç»„æ ¼å¼ï¼Œæ–¹ä¾¿æŒ‰è¡Œå¤„ç†)
            const sheetData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
            
            parseCustomFormat(sheetData);
        };
        reader.readAsArrayBuffer(file);
        input.value = ''; // é‡ç½® input
    }

    // æ ¸å¿ƒè§£æé€»è¾‘ï¼šä¸“é—¨å¤„ç†ä½ çš„é‚£ç§æ¨ªå‘æ’å¸ƒçš„ Excel
    function parseCustomFormat(rows) {
        if (rows.length < 5) {
            alert("æ•°æ®è¡Œæ•°å¤ªå°‘ï¼Œæ— æ³•è§£æã€‚");
            return;
        }

        // ç¬¬0è¡Œæ˜¯è€ƒè¯•åç§° (å¦‚ï¼šç†ç§‘äº”ç­ç»“è¯¾,,,, 11.1è”è€ƒ,,,,)
        const examNameRow = rows[0];
        // ç¬¬3è¡Œæ˜¯è¡¨å¤´ (å¦‚ï¼šå§“å, è‹±è¯­, è®¡ç®—æœº...) (ç´¢å¼•ä»0å¼€å§‹)
        const headerRow = rows[3]; 

        globalExamData = {};
        examNamesList = [];

        // éå†åˆ—ï¼Œå¯»æ‰¾â€œå§“åâ€åˆ—ï¼Œä½œä¸ºä¸€ä¸ªè€ƒè¯•åŒºå—çš„å¼€å§‹
        for (let col = 0; col < headerRow.length; col++) {
            if (headerRow[col] && headerRow[col].toString().trim() === 'å§“å') {
                
                // æ‰¾åˆ°ä¸€ä¸ªè€ƒè¯•åŒºå—
                // 1. è·å–è€ƒè¯•åç§° (é€šå¸¸åœ¨ç¬¬0è¡Œçš„å¯¹åº”åˆ—ï¼Œæˆ–è€…æ˜¯è¯¥åˆ—çš„å‰é¢å‡ åˆ—)
                // ä½ çš„è¡¨æ ¼ä¸­ï¼Œè€ƒè¯•åå†™åœ¨è¿™ä¸€ç»„çš„ç¬¬ä¸€åˆ—ä¸Šæ–¹
                let examName = examNameRow[col];
                
                // å¦‚æœå½“å‰åˆ—ç¬¬0è¡Œæ˜¯ç©ºçš„ï¼Œå¯èƒ½æ˜¯åˆå¹¶å•å…ƒæ ¼ï¼Œå‘å‰æ‰¾
                if (!examName && col > 0) examName = examNameRow[col-1];
                if (!examName) examName = `æœªå‘½åè€ƒè¯•_${examNamesList.length + 1}`;

                // å»é‡å¤„ç†
                if (globalExamData[examName]) {
                    examName = examName + "_2";
                }
                
                examNamesList.push(examName);
                globalExamData[examName] = [];

                // 2. ç¡®å®šè¯¥åŒºå—åŒ…å«å“ªäº›åˆ— (å§“å, è‹±è¯­, è®¡ç®—æœº, æ•°å­¦, æ€»åˆ†)
                // ç®€å•çš„é€»è¾‘ï¼šä»å½“å‰ col å¼€å§‹ï¼Œè¯»å–ç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ª "å§“å" æˆ–æ•°ç»„ç»“æŸ
                let fieldMap = {}; // è®°å½• å­—æ®µå -> åˆ—ç´¢å¼•
                let tempC = col;
                while (tempC < headerRow.length) {
                    const header = headerRow[tempC];
                    if (tempC !== col && header === 'å§“å') break; // é‡åˆ°ä¸‹ä¸€ä¸ªåŒºå—äº†
                    if (header) {
                        fieldMap[header] = tempC;
                    }
                    tempC++;
                }

                // 3. è¯»å–è¯¥åˆ—ä¸‹æ–¹çš„æ‰€æœ‰å­¦ç”Ÿæ•°æ® (ä»ç¬¬4è¡Œå¼€å§‹ï¼Œå³ç´¢å¼•4)
                for (let r = 4; r < rows.length; r++) {
                    const rowData = rows[r];
                    const studentName = rowData[fieldMap['å§“å']];

                    // åœæ­¢æ¡ä»¶ï¼šåå­—ä¸ºç©ºï¼Œæˆ–è€…åå­—æ˜¯â€œå¹³å‡åˆ†â€
                    if (!studentName) continue;
                    if (studentName.toString().includes('å¹³å‡åˆ†')) continue;

                    // æå–åˆ†æ•°
                    const studentObj = {
                        name: studentName,
                        english: parseScore(rowData[fieldMap['è‹±è¯­']]),
                        computer: parseScore(rowData[fieldMap['è®¡ç®—æœº']]),
                        math: parseScore(rowData[fieldMap['æ•°å­¦']]),
                        total: parseScore(rowData[fieldMap['æ€»åˆ†']])
                    };

                    globalExamData[examName].push(studentObj);
                }
            }
        }

        if (examNamesList.length === 0) {
            alert("æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„è€ƒè¯•æ•°æ®å—ï¼Œè¯·æ£€æŸ¥è¡¨å¤´æ˜¯å¦åŒ…å«'å§“å'åˆ—ã€‚");
            return;
        }

        initSelectors();
    }

    // è¾…åŠ©å‡½æ•°ï¼šå°†å•å…ƒæ ¼æ•°æ®è½¬ä¸ºæ•°å­—ï¼Œå¦‚æœæ˜¯ç©ºæˆ–éæ•°å­—åˆ™è¿”å› 0
    function parseScore(val) {
        if (val === undefined || val === null || val === '') return 0;
        const num = parseFloat(val);
        return isNaN(num) ? 0 : num;
    }

    // åˆå§‹åŒ–ä¸‹æ‹‰æ¡†
    function initSelectors() {
        const curSelect = document.getElementById('currentExamSelect');
        const prevSelect = document.getElementById('prevExamSelect');
        
        curSelect.innerHTML = '';
        prevSelect.innerHTML = '';

        // å¡«å……é€‰é¡¹
        examNamesList.forEach((name, index) => {
            curSelect.add(new Option(name, name));
            prevSelect.add(new Option(name, name));
        });

        // é»˜è®¤é€‰ä¸­ï¼šæœ¬æ¬¡é€‰æœ€åä¸€ä¸ªï¼Œå¯¹æ¯”é€‰å€’æ•°ç¬¬äºŒä¸ª
        if (examNamesList.length > 0) {
            curSelect.value = examNamesList[examNamesList.length - 1];
        }
        if (examNamesList.length > 1) {
            prevSelect.value = examNamesList[examNamesList.length - 2];
        } else {
             prevSelect.value = examNamesList[0];
        }

        updateAnalysis();
    }

    // æ ¸å¿ƒé€»è¾‘ï¼šå¯¹æ¯”å¹¶æ¸²æŸ“
    function updateAnalysis() {
        const curExamName = document.getElementById('currentExamSelect').value;
        const prevExamName = document.getElementById('prevExamSelect').value;

        const currentData = globalExamData[curExamName] || [];
        const prevData = globalExamData[prevExamName] || [];

        // 1. å°†å¯¹æ¯”æ•°æ®è½¬ä¸º Map æ–¹ä¾¿æŸ¥æ‰¾: name -> score
        const prevMap = {};
        prevData.forEach(s => prevMap[s.name] = s.total);

        // 2. è®¡ç®—æœ¬æ¬¡è€ƒè¯•ç»Ÿè®¡ä¿¡æ¯
        let totalScoreSum = 0;
        let maxScore = 0;
        let validCount = 0;

        currentData.forEach(s => {
            if (s.total > 0) {
                totalScoreSum += s.total;
                maxScore = Math.max(maxScore, s.total);
                validCount++;
            }
        });
        const avgScore = validCount > 0 ? (totalScoreSum / validCount) : 0;

        // 3. ç»Ÿè®¡æ¶¨è·Œäººæ•°
        let progressCount = 0;
        let regressCount = 0;

        // 4. æ¸²æŸ“è¡¨æ ¼
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        currentData.forEach(currStudent => {
            const tr = document.createElement('tr');
            
            // è·å–å¯¹æ¯”æˆç»©
            const prevTotal = prevMap[currStudent.name] !== undefined ? prevMap[currStudent.name] : '-';
            
            // è®¡ç®—å˜åŒ–
            let diffHtml = '<span class="diff-neutral">-</span>';
            let diffVal = 0;
            
            if (prevTotal !== '-' && currStudent.total > 0) {
                diffVal = currStudent.total - prevTotal;
                if (diffVal > 0) {
                    diffHtml = `<span class="diff-pos">â†‘ ${diffVal.toFixed(1)}</span>`;
                    progressCount++;
                } else if (diffVal < 0) {
                    diffHtml = `<span class="diff-neg">â†“ ${Math.abs(diffVal).toFixed(1)}</span>`;
                    regressCount++;
                }
            }

            // è®¡ç®—ä¸å‡åˆ†å·®è·
            let avgDiff = currStudent.total - avgScore;
            let avgBadgeClass = avgDiff >= 0 ? 'bg-green' : 'bg-red';
            let avgSign = avgDiff >= 0 ? '+' : '';
            
            // å•ç§‘æ˜¾ç¤º
            const subjects = `
                <span class="sub-score">è‹±:<span>${currStudent.english}</span></span>
                <span class="sub-score">è®¡:<span>${currStudent.computer}</span></span>
                <span class="sub-score">æ•°:<span>${currStudent.math}</span></span>
            `;

            tr.innerHTML = `
                <td style="font-weight:600">${currStudent.name}</td>
                <td style="color:#64748b">${prevTotal}</td>
                <td style="font-weight:bold; font-size:1.05rem">${currStudent.total}</td>
                <td>${diffHtml}</td>
                <td><span class="badge ${avgBadgeClass}">${avgSign}${avgDiff.toFixed(1)}</span></td>
                <td>${subjects}</td>
            `;
            tbody.appendChild(tr);
        });

        // 5. æ›´æ–°é¡¶éƒ¨ç»Ÿè®¡æ 
        document.getElementById('statsBar').style.display = 'grid';
        document.getElementById('statAvg').innerText = avgScore.toFixed(1);
        document.getElementById('statMax').innerText = maxScore;
        document.getElementById('statProgress').innerText = progressCount;
        document.getElementById('statRegress').innerText = regressCount;
        
        document.getElementById('examInfo').innerText = `å½“å‰åˆ†æ: ${currentData.length} äººå‚è€ƒ`;
    }
</script>

</body>
</html>